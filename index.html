<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <title>JavaScript Lesson4</title>
</head>

<body>
    <div id="quiz-container" class="quiz-container">
        <h2 id="quiz-title">ようこそ</h2>
        <h3 id="quiz-category"></h3>
        <h3 id="quiz-difficulty"></h3>
        <div id="question" class="question">以下のボタンをクリック</div>
        <ul id="answers"></ul>
        <button id="start-button">開始</button>
    </div>
    <style>
        ul {
            list-style-type: none;
            margin-block-start: 0;
            margin-block-end: 0;
            padding-inline-start: 0;
        }
        
        .question {
            margin-bottom: 2rem;
            padding: .5rem 0;
            border-top: 1px solid #000;
            border-bottom: 1px solid #000;
        }
    </style>
    <script>
        const apiUrl = 'https://opentdb.com/api.php?amount=10';

        class Quiz {
            constructor(quizData) {
                this.quizzes = quizData.results;
                this.currentIndex = 0;
                this.score = 0;
            }
        }

        const quizContainer = document.getElementById('quiz-container');
        const quizTitle = document.getElementById('quiz-title');
        const quizCategory = document.getElementById('quiz-category');
        const quizDifficulty = document.getElementById('quiz-difficulty');
        const quizContent = document.getElementById('question')
        const answersContainer = document.getElementById('answers');
        const startButton = document.getElementById('start-button');

        startButton.addEventListener('click', (event) => {
            getQuizData();
        });

        const getQuizData = async() => {
            quizTitle.textContent = '取得中です';
            quizContent.textContent = '少々お待ちください';
            startButton.hidden = true;

            const response = await fetch(apiUrl);
            const quizData = await response.json();
            const quizInstance = new Quiz(quizData);

            setNextQuiz(quizInstance);
        };

        const setNextQuiz = (quizInstance) => {
            quizTitle.textContent = '';
            quizCategory.textContent = '';
            quizDifficulty.textContent = '';
            quizContent.textContent = '';
            removeAnswers();

            if (quizInstance.currentIndex < quizInstance.quizzes.length) {
                const quiz = quizInstance.quizzes[quizInstance.currentIndex];
                makeQuiz(quizInstance, quiz);
            } else {
                finishQuiz(quizInstance);
            }
        };

        const finishQuiz = (quizInstance) => {
            quizTitle.textContent = `あなたの正解数${quizInstance.score}です！！`;
            quizContent.textContent = `再度チャレンジしたい場合は以下をクリック！！`;
            const createTopButton = document.createElement('button');
            const returnTopButton = quizContainer.appendChild(createTopButton);
            returnTopButton.id = 'return-top-button';
            returnTopButton.textContent = 'ホーム戻る';

            returnTopButton.addEventListener('click', (event) => {
                returnTop();
            });
        };

        const returnTop = () => {
            quizTitle.textContent = 'ようこそ';
            quizContent.textContent = '以下のボタンをクリック';
            startButton.hidden = false;
            const topButton = document.getElementById('return-top-button');
            topButton.remove();
        }

        const removeAnswers = () => {
            while (answersContainer.firstChild) {
                answersContainer.removeChild(answersContainer.firstChild);
            }
        };

        const makeQuiz = (quizInstance, quiz) => {
            const answers = makeAnswers(quiz);

            quizTitle.textContent = `問題${quizInstance.currentIndex + 1}`;
            quizCategory.textContent = `【ジャンル】${unescapeHTML(quiz.category)}`;
            quizDifficulty.textContent = `【難易度】${quiz.difficulty}`;
            quizContent.textContent = unescapeHTML(quiz.question);

            answers.forEach((answer) => {
                const answerListItem = document.createElement('li');
                const answerButtonItem = answersContainer.appendChild(answerListItem);
                answerButtonItem.innerHTML = `<button>${unescapeHTML(answer)}</button>`;

                answerButtonItem.addEventListener('click', (event) => {
                    correctAnswer = unescapeHTML(quiz.correct_answer);
                    if (event.target.textContent === correctAnswer) {
                        quizInstance.score++;
                    }

                    quizInstance.currentIndex++;
                    setNextQuiz(quizInstance);
                });
            });
        };

        const makeAnswers = (quiz) => {
            const answers = [
                quiz.correct_answer,
                ...quiz.incorrect_answers
            ];

            const shuffledAnswers = shuffle(answers);

            return shuffledAnswers;
        };

        const shuffle = (array) => {
            const shuffleArray = array.slice();
            for (let i = shuffleArray.length - 1; i >= 0; i--) {
                const rand = Math.floor(Math.random() * (i + 1));
                [shuffleArray[i], shuffleArray[rand]] = [shuffleArray[rand], shuffleArray[i]]
            }

            return shuffleArray;
        };

        const unescapeHTML = (str) => {
            const div = document.createElement("div");
            div.innerHTML = str.replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/ /g, "&nbsp;")
                .replace(/\r/g, "&#13;")
                .replace(/\n/g, "&#10;");

            return div.textContent || div.innerText;
        };
    </script>
</body>

</html>